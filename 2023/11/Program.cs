using System;
using System.Diagnostics;
using System.Runtime.CompilerServices;
using System.Text;
using common;
using common.SparseMatrix;


namespace _11
{

    internal class Program
    {

        const StringSplitOptions Tidy = StringSplitOptions.TrimEntries | StringSplitOptions.RemoveEmptyEntries;
        static readonly string xinput = @"
...#......
.......#..
#.........
..........
......#...
.#........
.........#
..........
.......#..
#...#.....";

        internal class Cell
        {
            public char Value { get; }
            public (int r, int c) Coordinate { get; set; }

            public Cell(char value, (int r, int c) coordinate)
            {
                Value = value;
                Coordinate = coordinate;
            }
        }

        static void Main(string[] args)
        {

            var galaxies = input.Split("\r\n", Tidy)
                .Select((x, r) => x.ToCharArray()
                    .Select((y, c) => new Cell(y, (r, c)))
                    .ToList())
                .ToList()
                .SelectMany(x => x)
                .Where(x => x.Value == '#')
                .OrderBy(x => x.Coordinate.r).ThenBy(x => x.Coordinate.c)
                .ToList();

            ExpandUniverse(galaxies, 1000000 - 1);

            var dist = 0L;
            var done = new Dictionary<((int, int), (int, int)), long>();
            foreach (var from in galaxies)
            {
                foreach (var to in galaxies)
                {
                    var t = to.Coordinate;
                    var f = from.Coordinate;
                    if (from != to && !done.ContainsKey((f, t)))
                    {
                        dist += Measure(f, t);
                        done[(f, t)] = dist;
                        done[(t, f)] = dist;
                    }
                }
            }

            Debug.WriteLine("distance :" + dist);
        }



        private static int Measure((int r, int c) startGalaxy, (int r, int c) targetGalaxy)
        {
            return Math.Abs(targetGalaxy.r - startGalaxy.r) + Math.Abs(targetGalaxy.c - startGalaxy.c);
        }

        private static void ExpandUniverse(List<Cell> galaxies, int expand)
        {
            var byRow = galaxies.GroupBy(x => x.Coordinate.r).OrderBy(x => x.Key).ToList();
            var lastKey = byRow.First().Key;
            foreach (var current in byRow)
            {
                var diff = current.Key - (lastKey + 1);
                if (diff > 0)
                {
                    var r = lastKey;
                    var expand1 = expand * diff;
                    byRow.Where(x => x.Key > r)
                        .SelectMany(x => x)
                        .ForEach((x, i) =>
                        {
                            x.Coordinate = (x.Coordinate.r + expand1, x.Coordinate.c);
                        });
                }
                lastKey = current.Key;
            }

            var byCol = galaxies.GroupBy(x => x.Coordinate.c).OrderBy(x => x.Key).ToList();
            lastKey = byCol.First().Key;
            foreach (var current in byCol)
            {
                var diff = current.Key - (lastKey + 1);
                if (diff > 0)
                {
                    var c = lastKey;
                    var expand1 = expand * diff;
                    byCol.Where(x => x.Key > c)
                         .SelectMany(x => x)
                         .ForEach((x, i) =>
                         {
                             x.Coordinate = (x.Coordinate.r, x.Coordinate.c + expand1);
                         });
                }
                lastKey = current.Key;
            }
        }



        private static readonly string input =
            @"
.#..........#.....................#........................................................#....................................#...........
...................#........................................#......................#........................................................
...........................................#......#..................#...................................................#..................
....#......................#...............................................#.........................#.....#......#................#........
.................................................................#.......................#..................................................
..............................................................................................................................#.............
.......#........#.............#...................................................#...................................#.....................
.........................#...................................#............................................................................#.
....................#.............#.........#..........................................#...............#....................................
.....................................................#...............#.............................................................#........
...........................................................................................................................#................
..........................................................#.........................................#...............#.......................
..............................................................................................#.............................................
.#........#........................#......#..............................................#..............................#...............#...
...............#......#...............................#.......#.........#......#.............................#.................#............
...............................#..............#.............................................................................................
............................................................................................................................................
.........................#.......................................#..........................................................................
..................#........................#......................................#........................................#................
..................................................#.......#..............................................#........................#.......#.
...#........#........................#....................................#...............#.................................................
............................................................................................................................................
.......#........................#....................................................................................#......................
...............#...........#........................................................................#.......................................
.............................................#................#.........#.............................................................#.....
...........#...........................#................#...........................#.......................................................
..................................................#.......................................#.............#...................................
.....#..................#..........#..............................#.............................#........................................#..
..............................#...............................................................................................#.............
...................................................................................................................#........................
..............#..........................................#.............#...........................#..............................#.........
...#...................................#.........................................#..........................................................
..................#...................................................................#................................................#....
..........................#...................................#.........................................#...................................
............................................................................................................................................
.........#...........#..........#..........................................#....................#..............#........#.....#...........#.
....................................................#.......................................................................................
.............................................#..............................................................................................
......................................#..................#..............................#...........#.......#...............................
............................#..................................#..............#.............................................................
...............#............................................................................................................................
...........................................#............................#.......................#...........................................
.....#..............#.................................................................................#...........................#.........
............................................................................................................................................
........................................#..........#.................#..........................................#...........................
.............................................#.................................#...........#................................................
...............................#.......................#...........................................#.......#....................#...........
#........#.............#...............................................................................................#...................#
.....................................#........................#..........#.........#........................................................
.................#............................................................................#.............................................
..........................#.......................................#.................................................#.......................
.....................................................#...................................#....................................#.............
..#.........................................................................................................................................
.............#.....#.......................#.............#....................................................#........................#....
......#........................................................................................#............................................
.................................#.................................#........................................................................
.................................................................................#.......................#................................#.
#.....................................................#...................................................................#.....#...........
.........#..................................................#......................................#........................................
..............................#.............#.................................................................#.......#.....................
........................#............................................................#......#................................#..............
.............#..............................................................................................................................
.....#........................................................#............#..........................#...........................#.........
...........................#......#.................................................................................#...................#...
.........#.....................................#...............................#............................................................
..................#.......................................#.......#................................#........................................
...............................#.....................#...................................#................................#.................
..............#..........................#.............................#............#.....................#.....................#.........#.
.................................................................................................................#..........................
......#.....................................................................................................................................
...........#.............#.........#........................................................................................................
...................................................................#..............#..................#......................................
..................#...........................................................................................#.............................
........#.................................#..............#.................................................................#..........#.....
...#.....................................................................#..............#.......#...........................................
............................................................................................................................................
............................................................................................................................................
.................................#................#..........................................................#...............#.............#
..............#............................................................#................................................................
......#.....................#..........................#........#.....#............#..............#.........................................
....................#..................................................................................#..................#.................
....................................#.........#........................................................................................#....
..........................................................#..............#..................................................................
................#...............................................................................................#.............#.............
............................................................................................................................................
............................#...................#......#.............#..............................................#.......................
.............#...................................................................................#........................................#.
......................#..........................................................#.......#..................................................
#...........................................................#...............................................................................
.........#.........................#.................#....................................................#.................#...............
............................................................................................................................................
...................#.............................................#.....#....................................................................
........................#.........................#.....................................................................................#...
.....#........................................................................................................................#.............
.......................................#...............................................................#.........#..........................
............................#...........................#...........#......................#..............................#.......#.........
..#................................#...........#............................................................................................
.................#..................................#...................#...................................................................
..........#.................................................#................................................#..............................
.....................#...............................................................................#......................................
..............#..................#..............................#.............#....................................#.........#........#.....
...#.............................................................................................#..........................................
............................................#..........................................#....................................................
.........#...............................................#..............................................................#...................
................#.........#.................................................................................................................
.....#..................................#............................#..............................#........#..................#..........#
...............................#............................................................................................................
....................................................#........#..............................................................................
........#..........................#.........#...............................................................................#..............
....................................................................................................................#.......................
....................#........#......................................#.........#.....#.....#.................................................
................................................................................................................................#.....#.....
...............#..........................................#...............#...............................#.................................
...#..............................#.........................................................................................................
........................................................................................#............#....................................#.
............................................................................................................................#...............
...................................................................................#............................#...........................
#........#........#........#..........#.........#...........................................................................................
.............................................................#..............................#............................#..................
................................#.......................#...................................................................................
.......................#................................................#...............#.........#..................#................#.....
............#..................................................................#........................#...................................
............................................................................................................................................
......#.....................#.......#......#..............#......#..........................................................................
.....................#......................................................................................................................
................................#................................................#.............#...........................#.............#..
..............................................................................................................#.............................
............#............#..........................................................................#.............................#.........
.....#...........#.....................#.............................#.....#........................................#.......................
................................................#...........#..........................#....................................................
............................................................................................................................................
#..........................#.....#................................................................#......................................#..
..........................................#.................................................................#.............#.................
................#.........................................................#.................................................................
.......#..............................#..............................................#..........................................#...........
........................#...................................#...............................................................................
............................................................................................................................#...............
..............................#.....................#.............................#...........#.................#...........................
...............................................#................#.....#................................................#....................
...................#...................#.................#.................#.........................#......................................
";
    }

}

